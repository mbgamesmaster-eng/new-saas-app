import React, { useState, useRef } from 'react';
import { Camera, Mic, MessageSquare, Send, Settings, TrendingUp, Dumbbell, Home, Zap, User, Plus, X, ChevronRight } from 'lucide-react';

const FitnessApp = () => {
  const [currentPage, setCurrentPage] = useState('signup');
  const [signupData, setSignupData] = useState({
    weight: '',
    height: '',
    gender: '',
    activityLevel: '',
    equipment: '',
    dietType: ''
  });
  const [userData, setUserData] = useState(null);
  const [foodLog, setFoodLog] = useState([]);
  const [workoutLog, setWorkoutLog] = useState([]);
  const [chatMessages, setChatMessages] = useState([]);
  const [chatInput, setChatInput] = useState('');
  const [forgePhotos, setForgePhotos] = useState([]);
  const [forgeAnalysis, setForgeAnalysis] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const fileInputRef = useRef(null);

  const calculateCalories = (data) => {
    const baseCalories = {
      male: data.weight * 15,
      female: data.weight * 13
    };
    
    const activityMultiplier = {
      sedentary: 1.2,
      light: 1.375,
      moderate: 1.55,
      active: 1.725,
      veryActive: 1.9
    };

    const base = baseCalories[data.gender] || 2000;
    const multiplier = activityMultiplier[data.activityLevel] || 1.2;
    return Math.round(base * multiplier);
  };

  const handleSignup = () => {
    const calories = calculateCalories(signupData);
    setUserData({
      ...signupData,
      dailyCalories: calories,
      protein: Math.round(signupData.weight * 0.8),
      carbs: Math.round((calories * 0.4) / 4),
      fats: Math.round((calories * 0.3) / 9)
    });
    setCurrentPage('dashboard');
  };

  const analyzeFoodImage = async () => {
    setIsLoading(true);
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: "Analyze this meal and estimate: food name, calories, protein(g), carbs(g), fats(g). Respond ONLY with JSON: {\"name\":\"...\",\"calories\":0,\"protein\":0,\"carbs\":0,\"fats\":0}"
          }]
        })
      });
      const data = await response.json();
      const text = data.content[0].text.replace(/```json|```/g, '').trim();
      const foodData = JSON.parse(text);
      setFoodLog([...foodLog, { ...foodData, time: new Date().toLocaleTimeString() }]);
    } catch (err) {
      console.error(err);
    }
    setIsLoading(false);
  };

  const logFoodText = async (text) => {
    setIsLoading(true);
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: `Parse this food entry: "${text}". Estimate calories, protein(g), carbs(g), fats(g). Respond ONLY with JSON: {\"name\":\"...\",\"calories\":0,\"protein\":0,\"carbs\":0,\"fats\":0}`
          }]
        })
      });
      const data = await response.json();
      const jsonText = data.content[0].text.replace(/```json|```/g, '').trim();
      const foodData = JSON.parse(jsonText);
      setFoodLog([...foodLog, { ...foodData, time: new Date().toLocaleTimeString() }]);
    } catch (err) {
      console.error(err);
    }
    setIsLoading(false);
  };

  const sendChatMessage = async () => {
    if (!chatInput.trim()) return;
    
    const userMessage = chatInput;
    setChatMessages([...chatMessages, { role: 'user', content: userMessage }]);
    setChatInput('');
    setIsLoading(true);

    const totalCalories = foodLog.reduce((sum, food) => sum + food.calories, 0);
    const totalProtein = foodLog.reduce((sum, food) => sum + food.protein, 0);

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: `You're a fitness coach. User's goals: ${userData.dailyCalories} calories, ${userData.protein}g protein. Today they ate: ${totalCalories} calories, ${totalProtein}g protein. Foods: ${foodLog.map(f => f.name).join(', ')}. Question: ${userMessage}`
          }]
        })
      });
      const data = await response.json();
      setChatMessages(prev => [...prev, { role: 'assistant', content: data.content[0].text }]);
    } catch (err) {
      console.error(err);
    }
    setIsLoading(false);
  };

  const analyzePhysique = async () => {
    setIsLoading(true);
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{
            role: "user",
            content: `Based on physique photos, estimate body fat % and create workout plan. User info: ${userData.gender}, ${userData.weight}lbs, equipment: ${userData.equipment}. Respond with JSON: {\"bodyFat\":0,\"plan\":\"...\",\"volume\":\"...\",\"recovery\":\"...\",\"calories\":0,\"exercises\":[]}`
          }]
        })
      });
      const data = await response.json();
      const text = data.content[0].text.replace(/```json|```/g, '').trim();
      const analysis = JSON.parse(text);
      setForgeAnalysis(analysis);
    } catch (err) {
      console.error(err);
    }
    setIsLoading(false);
  };

  if (currentPage === 'signup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-6">
        <div className="max-w-md mx-auto bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl">
          <h1 className="text-4xl font-bold text-white mb-2">Welcome to FORGE</h1>
          <p className="text-purple-200 mb-8">Your AI-Powered Fitness Journey</p>
          
          <div className="space-y-4">
            <input
              type="number"
              placeholder="Weight (lbs)"
              className="w-full bg-white/20 text-white placeholder-purple-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.weight}
              onChange={(e) => setSignupData({...signupData, weight: e.target.value})}
            />
            
            <input
              type="number"
              placeholder="Height (inches)"
              className="w-full bg-white/20 text-white placeholder-purple-200 rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.height}
              onChange={(e) => setSignupData({...signupData, height: e.target.value})}
            />
            
            <select
              className="w-full bg-white/20 text-white rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.gender}
              onChange={(e) => setSignupData({...signupData, gender: e.target.value})}
            >
              <option value="">Select Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
            
            <select
              className="w-full bg-white/20 text-white rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.activityLevel}
              onChange={(e) => setSignupData({...signupData, activityLevel: e.target.value})}
            >
              <option value="">Activity Level</option>
              <option value="sedentary">Sedentary (No workouts)</option>
              <option value="light">Light (1-2x/week)</option>
              <option value="moderate">Moderate (3-4x/week)</option>
              <option value="active">Active (5-6x/week)</option>
              <option value="veryActive">Very Active (Daily)</option>
            </select>
            
            <select
              className="w-full bg-white/20 text-white rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.equipment}
              onChange={(e) => setSignupData({...signupData, equipment: e.target.value})}
            >
              <option value="">Equipment Access</option>
              <option value="full">Full Gym</option>
              <option value="home">Home Gym</option>
              <option value="limited">Limited Equipment</option>
              <option value="bodyweight">Bodyweight Only</option>
            </select>
            
            <select
              className="w-full bg-white/20 text-white rounded-xl p-4 outline-none focus:ring-2 focus:ring-purple-400"
              value={signupData.dietType}
              onChange={(e) => setSignupData({...signupData, dietType: e.target.value})}
            >
              <option value="">Diet Type</option>
              <option value="balanced">Balanced</option>
              <option value="lowCarb">Low Carb</option>
              <option value="highProtein">High Protein</option>
              <option value="vegan">Vegan</option>
              <option value="keto">Keto</option>
            </select>
            
            <button
              onClick={handleSignup}
              disabled={!signupData.weight || !signupData.gender || !signupData.activityLevel}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 rounded-xl hover:opacity-90 transition disabled:opacity-50"
            >
              Create Account
            </button>
          </div>
        </div>
      </div>
    );
  }

  const totalCalories = foodLog.reduce((sum, food) => sum + food.calories, 0);
  const totalProtein = foodLog.reduce((sum, food) => sum + food.protein, 0);

  return (
    <div className="min-h-screen bg-gray-900 text-white">
      {/* Dashboard */}
      {currentPage === 'dashboard' && (
        <div className="p-6 pb-24">
          <h1 className="text-3xl font-bold mb-6">Dashboard</h1>
          
          <div className="bg-gradient-to-br from-purple-600 to-blue-600 rounded-3xl p-6 mb-6 shadow-lg">
            <h2 className="text-xl font-semibold mb-4">Daily Calories</h2>
            <div className="text-5xl font-bold mb-2">{totalCalories} / {userData.dailyCalories}</div>
            <div className="w-full bg-white/20 rounded-full h-3 mb-4">
              <div className="bg-white rounded-full h-3" style={{width: `${Math.min(100, (totalCalories/userData.dailyCalories)*100)}%`}}></div>
            </div>
            <div className="grid grid-cols-3 gap-4 text-sm">
              <div>
                <div className="text-purple-200">Protein</div>
                <div className="font-bold">{totalProtein}g / {userData.protein}g</div>
              </div>
              <div>
                <div className="text-purple-200">Carbs</div>
                <div className="font-bold">{foodLog.reduce((s,f)=>s+f.carbs,0)}g / {userData.carbs}g</div>
              </div>
              <div>
                <div className="text-purple-200">Fats</div>
                <div className="font-bold">{foodLog.reduce((s,f)=>s+f.fats,0)}g / {userData.fats}g</div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div className="bg-gray-800 rounded-2xl p-4">
              <Dumbbell className="w-8 h-8 mb-2 text-blue-400" />
              <div className="text-sm text-gray-400">Workouts</div>
              <div className="text-2xl font-bold">{workoutLog.length}</div>
            </div>
            <div className="bg-gray-800 rounded-2xl p-4">
              <TrendingUp className="w-8 h-8 mb-2 text-green-400" />
              <div className="text-sm text-gray-400">Meals Logged</div>
              <div className="text-2xl font-bold">{foodLog.length}</div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-2xl p-6">
            <h3 className="font-bold text-lg mb-4">Log Food</h3>
            <div className="space-y-3">
              <button onClick={analyzeFoodImage} className="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-xl flex items-center justify-center gap-2">
                <Camera className="w-5 h-5" />
                Take Photo
              </button>
              <button onClick={() => document.getElementById('foodInput').focus()} className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl flex items-center justify-center gap-2">
                <MessageSquare className="w-5 h-5" />
                Type Food
              </button>
              <input
                id="foodInput"
                type="text"
                placeholder="e.g., chicken breast 200g, brown rice 1 cup"
                className="w-full bg-gray-700 text-white rounded-xl p-3 outline-none"
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && e.target.value) {
                    logFoodText(e.target.value);
                    e.target.value = '';
                  }
                }}
              />
            </div>

            {foodLog.length > 0 && (
              <div className="mt-6">
                <h4 className="font-semibold mb-3">Today's Log</h4>
                {foodLog.map((food, i) => (
                  <div key={i} className="bg-gray-700 rounded-xl p-3 mb-2">
                    <div className="flex justify-between items-start">
                      <div>
                        <div className="font-semibold">{food.name}</div>
                        <div className="text-sm text-gray-400">{food.time}</div>
                      </div>
                      <div className="text-right">
                        <div className="text-purple-400 font-bold">{food.calories} cal</div>
                        <div className="text-xs text-gray-400">P:{food.protein}g C:{food.carbs}g F:{food.fats}g</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="mt-6 bg-gray-800 rounded-2xl p-6">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
              <MessageSquare className="w-5 h-5" />
              AI Nutrition Coach
            </h3>
            <div className="space-y-3 mb-4 max-h-60 overflow-y-auto">
              {chatMessages.map((msg, i) => (
                <div key={i} className={`p-3 rounded-xl ${msg.role === 'user' ? 'bg-purple-600 ml-8' : 'bg-gray-700 mr-8'}`}>
                  {msg.content}
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="Ask about your nutrition..."
                className="flex-1 bg-gray-700 rounded-xl p-3 outline-none"
                value={chatInput}
                onChange={(e) => setChatInput(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
              />
              <button onClick={sendChatMessage} className="bg-purple-600 hover:bg-purple-700 p-3 rounded-xl">
                <Send className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Forge Section */}
      {currentPage === 'forge' && (
        <div className="p-6 pb-24">
          <h1 className="text-3xl font-bold mb-6 flex items-center gap-3">
            <Zap className="w-8 h-8 text-yellow-400" />
            FORGE - AI Coach
          </h1>
          
          <div className="bg-gradient-to-br from-orange-600 to-red-600 rounded-3xl p-6 mb-6">
            <h2 className="text-xl font-semibold mb-4">Upload Physique Photos</h2>
            <p className="text-sm text-orange-100 mb-4">Upload multiple angles for accurate analysis</p>
            <button className="w-full bg-white text-orange-600 font-bold py-3 rounded-xl hover:bg-orange-50 transition">
              <Camera className="w-5 h-5 inline mr-2" />
              Upload Photos
            </button>
            {forgePhotos.length > 0 && (
              <div className="mt-4">
                <div className="text-sm mb-2">{forgePhotos.length} photos uploaded</div>
                <button onClick={analyzePhysique} className="w-full bg-yellow-400 text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-300 transition">
                  Analyze Physique
                </button>
              </div>
            )}
          </div>

          {forgeAnalysis && (
            <div className="space-y-4">
              <div className="bg-gray-800 rounded-2xl p-6">
                <h3 className="text-lg font-bold mb-3">Body Composition</h3>
                <div className="text-4xl font-bold text-yellow-400 mb-2">{forgeAnalysis.bodyFat}% Body Fat</div>
                <p className="text-gray-400">Estimated from your photos</p>
              </div>

              <div className="bg-gray-800 rounded-2xl p-6">
                <h3 className="text-lg font-bold mb-3">Workout Plan</h3>
                <p className="text-gray-300 mb-3">{forgeAnalysis.plan}</p>
                <div className="text-sm text-gray-400">
                  <div className="mb-2"><strong>Volume:</strong> {forgeAnalysis.volume}</div>
                  <div><strong>Recovery:</strong> {forgeAnalysis.recovery}</div>
                </div>
              </div>

              <div className="bg-gray-800 rounded-2xl p-6">
                <h3 className="text-lg font-bold mb-3">Updated Caloric Intake</h3>
                <div className="text-3xl font-bold text-green-400">{forgeAnalysis.calories} calories/day</div>
              </div>

              {forgeAnalysis.exercises && forgeAnalysis.exercises.length > 0 && (
                <div className="bg-gray-800 rounded-2xl p-6">
                  <h3 className="text-lg font-bold mb-3">Recommended Exercises</h3>
                  <ul className="space-y-2">
                    {forgeAnalysis.exercises.map((ex, i) => (
                      <li key={i} className="flex items-center gap-2 text-gray-300">
                        <ChevronRight className="w-4 h-4 text-yellow-400" />
                        {ex}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* Workout Section */}
      {currentPage === 'workout' && (
        <div className="p-6 pb-24">
          <h1 className="text-3xl font-bold mb-6">Workouts</h1>
          
          <button className="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-4 rounded-2xl font-bold mb-6 flex items-center justify-center gap-2">
            <Plus className="w-6 h-6" />
            Log Workout
          </button>

          {forgeAnalysis && (
            <div className="bg-gray-800 rounded-2xl p-6 mb-6">
              <h3 className="text-lg font-bold mb-4">AI Generated Plan</h3>
              <div className="space-y-3">
                <div className="bg-gray-700 rounded-xl p-4">
                  <div className="font-semibold text-purple-400">Monday - Chest & Triceps</div>
                  <div className="text-sm text-gray-400 mt-1">4 exercises • 16 sets</div>
                </div>
                <div className="bg-gray-700 rounded-xl p-4">
                  <div className="font-semibold text-blue-400">Wednesday - Back & Biceps</div>
                  <div className="text-sm text-gray-400 mt-1">5 exercises • 18 sets</div>
                </div>
                <div className="bg-gray-700 rounded-xl p-4">
                  <div className="font-semibold text-green-400">Friday - Legs</div>
                  <div className="text-sm text-gray-400 mt-1">6 exercises • 20 sets</div>
                </div>
              </div>
            </div>
          )}

          {workoutLog.length > 0 && (
            <div className="bg-gray-800 rounded-2xl p-6">
              <h3 className="text-lg font-bold mb-4">Recent Workouts</h3>
              {workoutLog.map((workout, i) => (
                <div key={i} className="bg-gray-700 rounded-xl p-4 mb-3">
                  <div className="font-semibold">{workout.name}</div>
                  <div className="text-sm text-gray-400">{workout.date}</div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Settings */}
      {currentPage === 'settings' && (
        <div className="p-6 pb-24">
          <h1 className="text-3xl font-bold mb-6">Settings</h1>
          
          <div className="bg-gray-800 rounded-2xl p-6 mb-4">
            <h3 className="text-lg font-bold mb-4">Profile</h3>
            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-400">Weight</span>
                <span className="font-semibold">{userData.weight} lbs</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Height</span>
                <span className="font-semibold">{userData.height} inches</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Gender</span>
                <span className="font-semibold capitalize">{userData.gender}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Activity Level</span>
                <span className="font-semibold capitalize">{userData.activityLevel}</span>
              </div>
            </div>
          </div>

          <div className="bg-gray-800 rounded-2xl p-6 mb-4">
            <h3 className="text-lg font-bold mb-4">Goals</h3>
            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-400">Daily Calories</span>
                <span className="font-semibold">{userData.dailyCalories}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Protein Target</span>
                <span className="font-semibold">{userData.protein}g</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Equipment</span>
                <span className="font-semibold capitalize">{userData.equipment}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-400">Diet Type</span>
                <span className="font-semibold capitalize">{userData.dietType}</span>
              </div>
            </div>
          </div>

          <button className="w-full bg-red-600 hover:bg-red-700 py-3 rounded-xl font-semibold transition">
            Reset All Data
          </button>
        </div>
      )}

      {/* Bottom Navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 px-4 py-3">
        <div className="flex justify-around items-center max-w-lg mx-auto">
          <button onClick={() => setCurrentPage('dashboard')} className={`flex flex-col items-center gap-1 ${currentPage === 'dashboard' ? 'text-purple-400' : 'text-gray-400'}`}>
            <Home className="w-6 h-6" />
            <span className="text-xs">Home</span>
          </button>
          <button onClick={() => setCurrentPage('forge')} className={`flex flex-col items-center gap-1 ${currentPage === 'forge' ? 'text-yellow-400' : 'text-gray-400'}`}>
            <Zap className="w-6 h-6" />
            <span className="text-xs">Forge</span>
          </button>
          <button onClick={() => setCurrentPage('workout')} className={`flex flex-col items-center gap-1 ${currentPage === 'workout' ? 'text-blue-400' : 'text-gray-400'}`}>
            <Dumbbell className="w-6 h-6" />
            <span className="text-xs">Workouts</span>
          </button>
          <button onClick={() => setCurrentPage('settings')} className={`flex flex-col items-center gap-1 ${currentPage === 'settings' ? 'text-green-400' : 'text-gray-400'}`}>
            <Settings className="w-6 h-6" />
            <span className="text-xs">Settings</span>
          </button>
        </div>
      </div>

      {isLoading && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
          <div className="bg-gray-800 rounded-2xl p-6 text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mx-auto mb-4"></div>
            <div className="text-white">AI Processing...</div>
          </div>
        </div>
      )}
    </div>
  );
};

export default FitnessApp;
